<!DOCTYPE html>
<html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>
<style>
  body {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }
  .ui {
    padding-left: 10px;
    padding-right: 10px;
    justify-content: space-between;
    width: 300px;
    text-align: center;
  }
  .dropdown {
    margin-top: 40px
  }
  button {
    margin-top: 80px;
  }
</style>

<body>
  <canvas id="myChart" style="width:1000px;max-width:70%"></canvas>

  <script>

    // ======================
    var ip = "62.21.50.49";
    var port = "8888";
    // ======================

    const addr = ip + ":" + port;

    const yAxisSpread = 3;
    const xAxisSpread = 3;

    var myList = [];
    var yVals = [];
    var yTitle = "Temperatura [st. C]";
    var xLabels = [];
    var dateAssociation = [];

    var chartDate = 0;
    var chartVal = "tm";
    var datasetName = "Temperatura";

    const chartableValues = [
      { name: "Temperatura", arg: "tm" },
      { name: "Wilgotnosc powietrza", arg: "ah" },
      { name: "Cisnienie atmosferyczne", arg: "ps" },
      { name: "Natezenie swiatla", arg: "lm" },
      { name: "Intensywnosc opadow", arg: "pr" },
      { name: "Predkosc wiatru", arg: "ws" },
      { name: "Wilgotnosc gleby (10cm)", arg: "g1" },
      { name: "Wilgotnosc gleby (30cm)", arg: "g3" },
      { name: "Wilgotnosc gleby (60cm)", arg: "g6" }
    ];

    async function executeAsync(url) {
      let response = await fetch(url);
      myList = await response.json();
      handleQueryString();
      drawDropdowns();
      fillData();
      //xLabels = [...Array(yVals.length).keys()];
      drawChart();
    }

    function handleQueryString() {
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      if (queryString != "") {
        chartDate = parseInt(urlParams.get("date"));
        chartVal = urlParams.get("val");
      }
    }

    function drawDropdowns() {
      const datesDropdown = document.getElementById("datesDropdown");
      var n = 0;
      let dates = [];
      for (element of myList) {
        dates.push(element["Data pomiaru"]);
      }
      let uniqueDates = [...new Set(dates)];
      for (element of uniqueDates) {
        let option = document.createElement("option");
        option.setAttribute('value', n);
        let optionText = document.createTextNode(element);
        option.appendChild(optionText);
        datesDropdown.appendChild(option);
        dateAssociation.push({ name: element, val: n });
        n++;
      }

      const valuesDropdown = document.getElementById("valuesDropdown");
      for (element of chartableValues) {
        let option = document.createElement("option");
        option.setAttribute('value', element["arg"]);
        let optionText = document.createTextNode(element["name"]);
        option.appendChild(optionText);
        valuesDropdown.appendChild(option);
      }

      datesDropdown.addEventListener("change", e => {
        chartDate = e.target.value;
        console.log(chartDate);
      });

      valuesDropdown.addEventListener("change", e => {
        chartValue = e.target.value;
      });

    }

    function fillData() {
      let valType = "";
      let valShort = "";
      let targetDate = "";

      for (date of dateAssociation) {
        if (date.val == chartDate) {
          targetDate = date.name;
        }
      }
      console.log("wybrana data: " + targetDate);

      for (element of chartableValues) {
        if (element.arg == chartVal) {
          valType = element.name;
          datasetName = valType;
          valShort = element.arg;
        }
      }

      datasetName += " dnia ";
      datasetName += targetDate;

      switch (valShort) {
        case "tm": yTitle = "Temperatura [st. C]"; break;
        case "ah": yTitle = "Wilgotnosc powietrza [%]"; break;
        case "ps": yTitle = "Cisnienie atmosferyczne [hPa]"; break;
        case "lm": yTitle = "Natezenie swiatla [lx]"; break;
        case "pr": yTitle = "Intensywnosc opadow"; break;
        case "ws": yTitle = "Predkosc wiatru"; break;
        case "g1": yTitle = "Wilgotnosc gleby (10cm)"; break;
        case "g3": yTitle = "Wilgotnosc gleby (30cm)"; break;
        case "g6": yTitle = "Wilgotnosc gleby (60cm)"; break;
      }

      console.log("wybrana wartosc: " + valType);
      for (const measurement of myList) {
        let recVal = measurement[valType];
        if (measurement["Data pomiaru"] == targetDate) {
          console.log("zarejestrowane dane: " + recVal);
          let finalVal = 0;
          if (valShort == "tm" || valShort == "ps" || valShort == "lm") {
            finalVal = parseFloat(recVal.substring(0, recVal.indexOf(" ")));
          }
          else if (valShort == "ah") {
            finalVal = parseFloat(recVal.substring(0, recVal.indexOf("%")));
          }
          else if (valShort == "pr") {
            switch (recVal) {
              case "Brak opadow": finalVal = 0.0; break;
              case "Lekkie opady": finalVal = 1.0; break;
              case "Umiarkowane opady": finalVal = 2.0; break;
              case "Silne opady": finalVal = 3.0; break;
            }
            console.log(finalVal);
          }
          else if (valShort == "ws") {
            switch (recVal) {
              case "Brak wiatru": finalVal = 0.0; break;
              case "Lekki wiatr": finalVal = 1.0; break;
              case "Umiarkowany wiatr": finalVal = 2.0; break;
              case "Silny wiatr": finalVal = 3.0; break;
            }
          }
          else if (valShort == "g1" || valShort == "g3" || valShort == "g6") {
            switch (recVal) {
              case "Gleba sucha": finalVal = 0.0; break;
              case "Gleba wilgotna": finalVal = 1.0; break;
              case "Gleba mokra": finalVal = 2.0; break;
            }
          }
          yVals.push(finalVal);
          xLabels.push(measurement['Godzina pomiaru']);
        }
      }


      // reset parametrow po ich odczytaniu
      chartDate = 0;
      chartValue = "tm";
    }

    function drawChart() {
    const theChart =  new Chart("myChart", {
        type: "line",
        data: {
          labels: xLabels,
          datasets: [{
            label: datasetName,
            data: yVals,
            fill: false,
            borderColor: 'rgb(75, 192, 192)',
            tension: 0.1
          }]
        },
        options: {
          legend: { 
            display: true,
            font: 20 
          },
          scales: {
            xAxes: [{
              display: true,
              ticks: {
                min: 0,
                max: yVals.length
              },
              scaleLabel: {
                fontSize: 20,
                display: true,
                labelString: "Godzina"
              }
            }],
            yAxes: [{
              display: true,
              ticks: {
                min: parseInt(Math.min(...yVals)) - yAxisSpread,
                max: parseInt(Math.max(...yVals)) + yAxisSpread
              },
              scaleLabel: {
                fontSize: 20,
                display: true,
                labelString: yTitle
              }
            }],
          },
        }
      });
    }

    // ===============================================
    executeAsync("http://" + addr + "/json/raw");

  </script>
  <div class="ui">

    <div class="dropdown">
      <select id="datesDropdown" style="height:30px;width:300px;font-size:20px;text-align: center;">
      </select>
    </div>

    <div class="dropdown">
      <select id="valuesDropdown" style="height:30px;width:300px;font-size:20px;text-align: center;">
      </select>
    </div>

    <button id="displayButton" style="height:70px;width:300px;font-size:25px;text-align: center;"
      class="float-left submit-button"> Wyswietl
      <script>
        document.getElementById("displayButton").onclick = function () {
          location.href = "?date=" + chartDate + "&val=" + chartValue;
        };
      </script>
    </button>
  
  </div>

</body>

</html>